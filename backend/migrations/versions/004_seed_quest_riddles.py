"""Seed 20 real quest riddles and update promo tier thresholds

Revision ID: 004_quest_riddles
Revises: 003_quest_models
Create Date: 2026-02-12

"""
from alembic import op
from sqlalchemy import text

revision = '004_quest_riddles'
down_revision = '003_quest_models'
branch_labels = None
depends_on = None


RIDDLES = [
    {
        'slug': 'hall-1',
        'order': 1,
        'title': 'Зал 1: Начало космической эры',
        'riddle_text': 'Самый первый. Его сигнал «бип-бип-бип» огласил начало космической эры. Он скромен по размерам, но велик по значению.',
        'fact_text': 'Верно! Первый искусственный спутник Земли был запущен в космос 4 октября 1957 г. прямо с космодрома «Байконур», сделал 1440 оборотов вокруг Земли, провёл в космосе 92 дня!',
        'qr_token': 'quest-hall-1',
    },
    {
        'slug': 'hall-2',
        'order': 2,
        'title': 'Зал 2: Белка и Стрелка',
        'riddle_text': 'Не просто собаки, а герои! Две из них вернулись живыми с орбиты и вошли в историю. Ищите их в самом начале звёздного пути. Рядом найдёте настоящий катапультируемый контейнер, который помог путешественницам вернуться на Землю.',
        'fact_text': 'Верно! Белка и Стрелка стали первыми животными, совершившими орбитальный полёт и успешно вернувшимися на Землю!',
        'qr_token': 'quest-hall-2',
    },
    {
        'slug': 'hall-3',
        'order': 3,
        'title': 'Зал 3: Корабль «Восток»',
        'riddle_text': 'Находясь внутри него, Юрий Гагарин сказал «Поехали!». Найдите тот самый корабль, точную его копию, в котором человек впервые увидел Землю из космоса.',
        'fact_text': 'Верно! Внутри макета спускаемого аппарата корабля «Восток» можно увидеть катапультируемое кресло космонавта, иллюминатор со снайперским прицелом и даже маленький глобус.',
        'qr_token': 'quest-hall-3',
    },
    {
        'slug': 'hall-4',
        'order': 4,
        'title': 'Зал 4: Скафандр СК-1',
        'riddle_text': 'Оранжевым его сделали для удобства видимости в любых условиях! А на его рукаве вы обнаружите маленькое зеркальце.',
        'fact_text': 'Скафандр «СК-1» создавали для первой шестёрки космонавтов, в том числе и для Ю. А. Гагарина.',
        'qr_token': 'quest-hall-4',
    },
    {
        'slug': 'hall-5',
        'order': 5,
        'title': 'Зал 5: Скафандр «Беркут»',
        'riddle_text': 'Скафандры сильно менялись с течением времени в зависимости от назначения. В зале «Утро космической эры» вы обнаружите первый в истории скафандр для выхода в открытый космос, в котором работал один очень известный космонавт.',
        'fact_text': 'Скафандр «Беркут» А. А. Леонова. Его сделали белым для безопасности космонавта, ведь Алексей Леонов работал в открытом космосе на солнечной стороне!',
        'qr_token': 'quest-hall-5',
    },
    {
        'slug': 'hall-6',
        'order': 6,
        'title': 'Зал 6: Станция «Луна-3»',
        'riddle_text': 'Фотографии обратной стороны Луны были сделаны именно этой станцией. Впоследствии их признали фотографиями века!',
        'fact_text': 'Автоматическая станция «Луна-3».',
        'qr_token': 'quest-hall-6',
    },
    {
        'slug': 'hall-7',
        'order': 7,
        'title': 'Зал 7: Скафандр «Сокол»',
        'riddle_text': 'Скафандры служат разным целям. Найдите скафандр с чемоданчиком-кондиционером, который охлаждает тело космонавта перед посадкой на корабль.',
        'fact_text': 'Скафандр «Сокол», который весит около 10 кг, используется для полёта на станцию и для возвращения на Землю.',
        'qr_token': 'quest-hall-7',
    },
    {
        'slug': 'hall-8',
        'order': 8,
        'title': 'Зал 8: Скафандр «Орлан-Д»',
        'riddle_text': 'Чтобы работать в открытом космосе, нужен особый костюм. Найдите полужёсткий скафандр с рюкзаком-спинкой, похожий на шкафчик.',
        'fact_text': 'Скафандр «Орлан-Д» для работы в открытом космосе.',
        'qr_token': 'quest-hall-8',
    },
    {
        'slug': 'hall-9',
        'order': 9,
        'title': 'Зал 9: Макет МКС',
        'riddle_text': 'Самая большая космическая стройка человечества. Её макет поражает размерами. Найдите модель, парящую под потолком, с солнечными батареями и модулями.',
        'fact_text': 'Макет Международной космической станции (МКС).',
        'qr_token': 'quest-hall-9',
    },
    {
        'slug': 'hall-10',
        'order': 10,
        'title': 'Зал 10: Станция «Мир»',
        'riddle_text': 'Это самый большой экспонат музея! Вы можете заглянуть внутрь и увидеть, как жили и работали первопроходцы долговременных полётов.',
        'fact_text': 'Полномасштабный макет базового блока орбитальной станции «Мир».',
        'qr_token': 'quest-hall-10',
    },
    {
        'slug': 'hall-11',
        'order': 11,
        'title': 'Зал 11: Космическая кухня',
        'riddle_text': 'Космическая кухня. Найдите устройство, в котором охлаждают еду на станции, и посмотрите на тюбики с настоящей космической пищей.',
        'fact_text': 'Космический холодильник и наборы космического питания (стенд с тюбиками и упаковками).',
        'qr_token': 'quest-hall-11',
    },
    {
        'slug': 'hall-12',
        'order': 12,
        'title': 'Зал 12: Космический хлеб',
        'riddle_text': 'Довольно серьёзную опасность в невесомости представляют любые мелкие предметы. В стенде с космическим питанием вы увидите привычный всем продукт в сильно уменьшенном виде.',
        'fact_text': 'Космический хлеб сделали миниатюрным специально для того, чтобы крошки не разлетались по отсекам станции!',
        'qr_token': 'quest-hall-12',
    },
    {
        'slug': 'hall-13',
        'order': 13,
        'title': 'Зал 13: Гидрокостюм «Форель»',
        'riddle_text': 'Возвращение на Землю — это тоже искусство. Найдите специальный гидрокостюм, который используют космонавты при приводнении.',
        'fact_text': 'Гидрокостюм «Форель».',
        'qr_token': 'quest-hall-13',
    },
    {
        'slug': 'hall-14',
        'order': 14,
        'title': 'Зал 14: Луноход-1',
        'riddle_text': 'Советский «лунный танк». Самоходный аппарат, дистанционно управляемый с Земли. Он оставил большие следы на лунном грунте.',
        'fact_text': 'Макет «Лунохода-1». Он прошёл по поверхности Луны 10 540 метров, что позволило детально её изучить.',
        'qr_token': 'quest-hall-14',
    },
    {
        'slug': 'hall-15',
        'order': 15,
        'title': 'Зал 15: Ракета Н1-Л3',
        'riddle_text': 'Гигантская ракета, которая должна была отправить советских космонавтов к Луне. Её двигатели — настоящие исполины. Найдите макет такой ракеты.',
        'fact_text': 'Макет ракеты Н1-Л3. Кстати, специально для работ на поверхности Луны, помимо огромной ракеты, был разработан и скафандр «Кречет», который вы увидите рядом.',
        'qr_token': 'quest-hall-15',
    },
    {
        'slug': 'hall-16',
        'order': 16,
        'title': 'Зал 16: Стыковочный узел',
        'riddle_text': 'Именно благодаря такой уникальной разработке В. Сыромятникова удалось обеспечить соединение на орбите двух совершенно разных кораблей — «Союз» и «Аполлон»!',
        'fact_text': 'Андрогинно-периферийный аппарат стыковки. Инженерное решение, предложенное конструктором, позволило выполнить на орбите стыковку советского «Союза» с американским «Аполлоном», а экипажам кораблей — встретиться над планетой: оба узла АПАС-75 обладали и «штырями», и «конусами» одновременно. Впоследствии подобные системы использовались на станциях «Мир» и МКС и для стыковки челноков Shuttle.',
        'qr_token': 'quest-hall-16',
    },
    {
        'slug': 'hall-17',
        'order': 17,
        'title': 'Зал 17: Ракета «Протон»',
        'riddle_text': 'Ракеты бывают не только для людей! Найдите ракету, благодаря которой на МКС отправляются различные грузы.',
        'fact_text': 'Ракета-носитель «Протон».',
        'qr_token': 'quest-hall-17',
    },
    {
        'slug': 'hall-18',
        'order': 18,
        'title': 'Зал 18: Корабль «Союз»',
        'riddle_text': 'Именно при помощи такого корабля в полёт отправляются современные космонавты. Загляните внутрь, и вы увидите предмет, знакомый всем по школьным урокам географии.',
        'fact_text': 'Спускаемый аппарат космического корабля «Союз». Внутри находится маленький глобус — навигатор.',
        'qr_token': 'quest-hall-18',
    },
    {
        'slug': 'hall-19',
        'order': 19,
        'title': 'Зал 19: Мундир Леонова',
        'riddle_text': 'Мундир настоящего Героя. Его владелец был не только первым в открытом космосе, но и руководил экипажем корабля «Союз» во время стыковки «Союз-Аполлон».',
        'fact_text': 'Парадный мундир А. А. Леонова с подлинными наградами.',
        'qr_token': 'quest-hall-19',
    },
    {
        'slug': 'hall-20',
        'order': 20,
        'title': 'Зал 20: Картины Леонова',
        'riddle_text': 'Представленные в картинной галерее работы были созданы рукой неоднократно летавшего космонавта!',
        'fact_text': 'Картины А. А. Леонова.',
        'qr_token': 'quest-hall-20',
    },
]


def upgrade():
    conn = op.get_bind()

    # Delete old placeholder riddles (5 from migration 003)
    conn.execute(text("DELETE FROM quest_progress"))
    conn.execute(text("DELETE FROM quest_pages"))

    # Insert all 20 real riddles
    for r in RIDDLES:
        conn.execute(text(
            "INSERT INTO quest_pages (slug, \"order\", title, riddle_text, fact_text, qr_token, points, is_active) "
            "VALUES (:slug, :order, :title, :riddle_text, :fact_text, :qr_token, 10, true)"
        ), r)

    # Update promo code pool thresholds: 5 riddles (max 50) → 20 riddles (max 200)
    conn.execute(text("UPDATE promo_code_pools SET min_score = 200 WHERE tier = 'gold'"))
    conn.execute(text("UPDATE promo_code_pools SET min_score = 160 WHERE tier = 'silver'"))
    conn.execute(text("UPDATE promo_code_pools SET min_score = 120 WHERE tier = 'bronze'"))


def downgrade():
    conn = op.get_bind()

    # Delete the 20 riddles
    conn.execute(text("DELETE FROM quest_progress"))
    conn.execute(text("DELETE FROM quest_pages"))

    # Re-insert original 5 placeholder riddles
    conn.execute(text("""
        INSERT INTO quest_pages (slug, "order", title, riddle_text, fact_text, image_url, qr_token, points, is_active)
        VALUES
        ('hall-1', 1, 'Зал 1: Начало космической эры',
         'Найдите экспонат, посвящённый первому искусственному спутнику Земли.',
         'Спутник-1 весил всего 83,6 кг и передавал радиосигнал в течение 21 дня.',
         '/images/quest/placeholder.png', 'quest-hall-1', 10, true),
        ('hall-2', 2, 'Зал 2: Первые полёты',
         'Отыщите скафандр первого человека, побывавшего в открытом космосе.',
         'Алексей Леонов провёл в открытом космосе 12 минут 9 секунд.',
         '/images/quest/placeholder.png', 'quest-hall-2', 10, true),
        ('hall-3', 3, 'Зал 3: Луна и планеты',
         'Найдите макет лунохода.',
         'Луноход-1 проработал на Луне 301 сутки.',
         '/images/quest/placeholder.png', 'quest-hall-3', 10, true),
        ('hall-4', 4, 'Зал 4: Орбитальные станции',
         'Отыщите модель орбитальной станции «Мир».',
         'Станция «Мир» находилась на орбите 15 лет.',
         '/images/quest/placeholder.png', 'quest-hall-4', 10, true),
        ('hall-5', 5, 'Зал 5: Современная космонавтика',
         'Найдите экспонат, посвящённый МКС.',
         'МКС весит около 420 тонн.',
         '/images/quest/placeholder.png', 'quest-hall-5', 10, true)
    """))

    # Revert promo thresholds
    conn.execute(text("UPDATE promo_code_pools SET min_score = 50 WHERE tier = 'gold'"))
    conn.execute(text("UPDATE promo_code_pools SET min_score = 40 WHERE tier = 'silver'"))
    conn.execute(text("UPDATE promo_code_pools SET min_score = 30 WHERE tier = 'bronze'"))
